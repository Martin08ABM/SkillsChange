---
// IMPORTACIÓN DE COMPONENTES
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import NavBar from '../components/NavBar.astro';

const { userId, redirectToSignIn } = Astro.locals.auth();
if (!userId) {
  return redirectToSignIn();
}
---

<Layout title="TeCambio - Crear un anuncio">
  <Header showPostButton={false} />
  <NavBar />

  <div class="flex flex-col gap-4 sm:gap-6 p-4 sm:p-6 max-w-xs sm:max-w-lg md:max-w-xl lg:max-w-2xl xl:max-w-3xl border-2 border-black bg-white shadow-lg rounded-xl mt-4 sm:mt-6 lg:mt-8 mb-4 sm:mb-6 lg:mb-8 sm:mx-6 lg:mx-12 mx-auto">
    <h1 class="text-2xl font-bold text-center mb-4">Crear Nuevo Anuncio</h1>
    
    <form class="flex flex-col gap-4 sm:gap-6" id="service-form">
      <!-- Nombre del anuncio -->
      <div class="flex flex-col">
        <label class="text-black text-lg sm:text-xl font-bold mb-2">
          Nombre del anuncio:
        </label>
        <input type="text" placeholder="Nombre anuncio" class="border-2 border-black rounded-xl p-2 text-sm sm:text-base" id="titulo" name="title" required />
      </div>

      <!-- Descripción del anuncio -->
      <div class="flex flex-col">
        <label class="text-black text-lg sm:text-xl font-bold mb-2">Descripción del anuncio:</label>
        <textarea placeholder="Descripción detallada del servicio" class="border-2 border-black rounded-xl p-2 text-sm sm:text-base min-h-[100px]" id="descripcion" name="description" required></textarea>
      </div>

      <!-- Imágenes del anuncio -->
      <div class="flex flex-col">
        <label class="text-black text-lg sm:text-xl font-bold mb-2">Subir imágenes del servicio:</label>
        <div class="flex items-center gap-2">
          <input type="file" class="border-2 border-gray-400 p-2 w-full max-w-sm sm:max-w-md lg:max-w-lg text-sm sm:text-base" accept=".jpg,.jpeg,.png,.webp" id="imagen" name="image" />
        </div>
        <h5 class="text-xs sm:text-sm mt-1">*Formatos admitidos: jpg, jpeg, png, webp (opcional)</h5>
      </div>

      <!-- ¿Anúncio físico o online? -->
      <div class="flex flex-col">
        <label class="text-black text-lg sm:text-xl font-bold mb-2">Tipo de servicio:</label>
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-4">
          <div class="flex items-center gap-2">
            <input type="checkbox" id="fisico" name="is_physical" class="w-4 h-4" />
            <label for="fisico" class="text-sm sm:text-base">Servicio físico</label>
          </div>
          <div class="flex items-center gap-2">
            <input type="checkbox" id="online" name="is_online" class="w-4 h-4" />
            <label for="online" class="text-sm sm:text-base">Servicio online</label>
          </div>
        </div>
      </div>

      <!-- Elegir método de "pago" o intercambio -->
      <div class="flex flex-col">
        <label class="text-black text-lg sm:text-xl font-bold mb-2">Método de intercambio:</label>
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-4">
          <div class="flex items-center gap-2">
            <input type="radio" id="pago" name="payment_type" class="w-4 h-4" value="paid" />
            <label for="pago" class="text-sm sm:text-base">Pago</label>
          </div>
          <div class="flex items-center gap-2">
            <input type="radio" id="trueque" name="payment_type" class="w-4 h-4" value="barter" />
            <label for="trueque" class="text-sm sm:text-base">Intercambio</label>
          </div>
        </div>
      </div>

      <!-- Establecer precio y moneda del anuncio -->
      <div class="flex-col hidden gap-4" id="price-section">
        <div class="flex flex-col">
            <label class="text-black text-lg sm:text-xl font-bold mb-2">Precio del servicio</label>
            <input type="number" step="0.01" min="0" placeholder="0.00" class="border-2 border-black rounded-xl p-2 text-sm sm:text-base" id="precio" name="price" />
        </div>
        <div class="flex flex-col">
            <label class="text-black text-lg sm:text-xl font-bold mb-2">Moneda</label>
            <select name="currency" id="currency" class="border-2 border-black rounded-xl p-2 text-sm sm:text-base bg-white">
                <option value="EUR">EUR (€)</option>
                <option value="USD">USD ($)</option>
                <option value="GBP">GBP (£)</option>
            </select>
        </div>
        <p class="text-xs text-gray-600 mt-2">*Los pagos se procesarán de forma segura a través de Stripe.</p>
      </div>

      <button type="submit" id="submit-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-xl transition-colors duration-200 self-start">
        Publicar Anuncio
      </button>
    </form>

    <!-- Mensaje de éxito -->
    <div id="success-message" class="hidden bg-green-100 border-2 border-green-500 text-green-700 p-4 rounded-xl mt-4">
      <h3 class="font-bold mb-2">¡Anuncio publicado exitosamente!</h3>
      <p class="mb-3">Tu anuncio ha sido creado y está disponible para los usuarios.</p>
      <div class="flex gap-2">
        <a href="/" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">Ver Anuncios</a>
        <button type="button" id="create-another" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">Crear Otro</button>
      </div>
    </div>
  </div>

  <Footer />
</Layout>

<script>
  const form = document.getElementById("service-form");
  const pagoRadio = document.getElementById("pago");
  const truequeRadio = document.getElementById("trueque");
  const priceSection = document.getElementById("price-section");
  const submitButton = document.getElementById("submit-button");
  const successMessage = document.getElementById("success-message");
  const createAnotherButton = document.getElementById("create-another");

  function togglePaymentSections() {
    if (pagoRadio.checked) {
      priceSection.style.display = "flex";
    } else {
      priceSection.style.display = "none";
    }
  }

  pagoRadio.addEventListener("change", togglePaymentSections);
  truequeRadio.addEventListener("change", togglePaymentSections);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    submitButton.disabled = true;
    submitButton.textContent = 'Publicando...';

    const formData = new FormData(form);
    
    formData.set('is_physical', document.getElementById('fisico').checked);
    formData.set('is_online', document.getElementById('online').checked);

    try {
      const response = await fetch('/api/services/create', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Algo salió mal');
      }

      form.style.display = 'none';
      successMessage.style.display = 'block';

    } catch (error) {
      alert(`Error: ${error.message}`);
      submitButton.disabled = false;
      submitButton.textContent = 'Publicar Anuncio';
    }
  });

  createAnotherButton.addEventListener("click", () => {
    form.reset();
    form.style.display = 'flex';
    successMessage.style.display = 'none';
    submitButton.disabled = false;
    submitButton.textContent = 'Publicar Anuncio';
    togglePaymentSections();
  });
</script>